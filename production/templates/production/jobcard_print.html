{% load i18n %}
<!DOCTYPE html>
<html lang="{% get_current_language as LANGUAGE_CODE %}{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_CODE == 'ar' %}rtl{% else %}ltr{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Card: {{ jobcard.jobcard_code }} - Route Sheet</title>

    <!-- Bootstrap CSS -->
    {% if LANGUAGE_CODE == 'ar' %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    {% else %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    {% endif %}

    <style>
        /* Print-optimized styles */
        @media print {
            body {
                margin: 0;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
            .page-break {
                page-break-before: always;
            }
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            thead {
                display: table-header-group;
            }
            .qr-code-cell {
                width: 120px !important;
                text-align: center !important;
            }
        }

        /* Screen styles */
        body {
            font-family: 'Arial', sans-serif;
            font-size: 12pt;
        }

        .header {
            border-bottom: 3px solid #000;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .job-info {
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .route-table {
            width: 100%;
            border-collapse: collapse;
        }

        .route-table th,
        .route-table td {
            border: 1px solid #000;
            padding: 10px;
        }

        .route-table th {
            background-color: #343a40;
            color: white;
            font-weight: bold;
            text-align: center;
        }

        .qr-code-cell {
            width: 120px;
            text-align: center;
            vertical-align: middle;
        }

        .qr-code-img {
            width: 100px;
            height: 100px;
            border: 1px solid #ccc;
        }

        .step-number {
            font-size: 18pt;
            font-weight: bold;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
        }

        .status-in-progress {
            background-color: #0dcaf0;
            color: #000;
        }

        .status-done {
            background-color: #198754;
            color: #fff;
        }

        .scan-instructions {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin-top: 20px;
        }

        @media screen {
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Print button (hidden when printing) -->
        <div class="no-print text-end mb-3">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="bi bi-printer"></i> Print Job Card
            </button>
            <a href="{% url 'production:jobcard-detail' jobcard.pk %}" class="btn btn-secondary">
                Back to Job Card
            </a>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="row">
                <div class="col-8">
                    <h1>{% trans "Production Department" %}</h1>
                    <h2>JOB CARD ROUTE SHEET</h2>
                </div>
                <div class="col-4 text-end">
                    <h3>{{ jobcard.jobcard_code }}</h3>
                    <p>Date: {{ jobcard.created_at|date:"Y-m-d" }}</p>
                </div>
            </div>
        </div>

        <!-- Job Card Information -->
        <div class="job-info">
            <div class="row">
                <div class="col-6">
                    <p><strong>Work Order:</strong> {{ jobcard.work_order.wo_number }}</p>
                    <p><strong>Customer:</strong> {{ jobcard.work_order.customer_name|default:"—" }}</p>
                    <p><strong>Bit Instance:</strong> {{ jobcard.work_order.bit_instance.serial_number|default:"—" }}</p>
                </div>
                <div class="col-6">
                    <p><strong>Department:</strong> {{ jobcard.get_department_display|default:"—" }}</p>
                    <p><strong>Priority:</strong> {{ jobcard.work_order.get_priority_display|default:"—" }}</p>
                    <p><strong>Due Date:</strong> {{ jobcard.work_order.due_date|date:"Y-m-d"|default:"—" }}</p>
                </div>
            </div>
            {% if jobcard.work_order.remarks %}
            <div class="row mt-2">
                <div class="col-12">
                    <p><strong>Remarks:</strong> {{ jobcard.work_order.remarks }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Route Steps with QR Codes -->
        <h3 class="mb-3">PROCESS ROUTE</h3>
        <table class="route-table">
            <thead>
                <tr>
                    <th style="width: 50px;">Step</th>
                    <th>Process Code</th>
                    <th>Department</th>
                    <th style="width: 150px;">Status</th>
                    <th style="width: 120px;">QR Code<br><small>(Scan to Start/Complete)</small></th>
                    <th style="width: 150px;">Operator Signature</th>
                </tr>
            </thead>
            <tbody>
                {% for item in steps_with_qr %}
                <tr>
                    <td class="text-center step-number">{{ item.step.sequence }}</td>
                    <td>
                        <strong>{{ item.step.process_code }}</strong>
                        {% if item.step.notes %}
                        <br><small>{{ item.step.notes }}</small>
                        {% endif %}
                    </td>
                    <td>{{ item.step.get_department_display }}</td>
                    <td class="text-center">
                        {% if item.step.status == 'PENDING' %}
                        <span class="status-badge status-pending">PENDING</span>
                        {% elif item.step.status == 'IN_PROGRESS' %}
                        <span class="status-badge status-in-progress">IN PROGRESS</span>
                        {% elif item.step.status == 'DONE' %}
                        <span class="status-badge status-done">DONE</span>
                        {% else %}
                        <span class="status-badge">{{ item.step.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td class="qr-code-cell">
                        <img src="{% url 'production:jobcard-qr' jobcard.pk %}?step={{ item.step.pk }}"
                             alt="QR Code for {{ item.step.process_code }}"
                             class="qr-code-img">
                        <br><small>{{ item.qr_code.code }}</small>
                    </td>
                    <td>
                        {% if item.step.actual_operator %}
                        {{ item.step.actual_operator.name }}<br>
                        <small>{{ item.step.actual_start|date:"Y-m-d H:i"|default:"—" }}</small>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No route steps defined.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Scanning Instructions -->
        <div class="scan-instructions no-print">
            <h5><i class="bi bi-info-circle"></i> Scanning Instructions:</h5>
            <ol>
                <li><strong>First Scan:</strong> Scan the QR code to START the process. The system will record your phone number, start time, and mark the process as IN PROGRESS.</li>
                <li><strong>Complete the Process:</strong> Perform the manufacturing operation.</li>
                <li><strong>Second Scan:</strong> Scan the SAME QR code again to COMPLETE the process. The system will record the end time and calculate duration.</li>
                <li><strong>Phone Recognition:</strong> Make sure to include your phone number when scanning (via URL parameter: ?phone=YOUR_NUMBER)</li>
            </ol>
        </div>

        <!-- Footer -->
        <div class="mt-5 pt-3" style="border-top: 1px solid #ccc;">
            <div class="row">
                <div class="col-4">
                    <p><strong>Prepared By:</strong></p>
                    <p>_____________________</p>
                    <p>Date: _____________</p>
                </div>
                <div class="col-4">
                    <p><strong>Supervisor:</strong></p>
                    <p>_____________________</p>
                    <p>Date: _____________</p>
                </div>
                <div class="col-4">
                    <p><strong>QC Inspector:</strong></p>
                    <p>_____________________</p>
                    <p>Date: _____________</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</body>
</html>
