{% extends 'production/base.html' %}
{% load bit_format %}
{% block title %}Bit Design Hub{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'production/css/bitdesign-hub-table.css' %}">
{% endblock %}

{% block content %}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'production:dashboard' %}"><i class="bi bi-house"></i> Production</a></li>
        <li class="breadcrumb-item active" aria-current="page">Bit Design Hub</li>
    </ol>
</nav>

<!-- Header with Search -->
<div class="row mb-3">
    <div class="col-md-6">
        <h1><i class="bi bi-grid-3x3-gap"></i> Bit Design Hub</h1>
        <p class="text-muted mb-0">Central junction for all bit designs (Levels 1-6) • {{ designs|length }} designs</p>
    </div>
    <div class="col-md-6 text-end">
        <a href="{% url 'production:bitdesign-create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> New Design
        </a>
    </div>
</div>

<!-- Hub Table -->
<div class="card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-table"></i> Designs & MAT Levels ({{ designs|length }} designs)</h5>
        <small class="text-white-50">Click any design row to expand/collapse levels</small>
    </div>
    <div class="card-body p-0">
        {% if designs %}
        <div class="hub-table-wrapper">
            <!-- Toolbar and filters will be inserted here by JavaScript -->
            <div class="hub-table-scroll-container">
                <table class="table table-sm" id="bitdesign-hub-table">
                <thead class="table-light">
                    <tr>
                        <th style="width:30px;"></th>
                        <th>Level</th>
                        <th>MAT</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>SMI Name</th>
                        <th>HDBS</th>
                        <th>IADC</th>
                        <th>Body</th>
                        <th>Blades</th>
                        <th>Cutter Cat</th>
                        <th>Gauge L.</th>
                        <th>Conn. Size</th>
                        <th>Conn. End</th>
                        <th>Drift</th>
                        <th>Nozzles</th>
                        <th>Ports</th>
                        <th>Nozzle Size</th>
                        <th>Conn. Type</th>
                        <th>Breaker W.</th>
                        <th>Breaker H.</th>
                        <th>Shank Dia.</th>
                        <th>Gauge Relief</th>
                        <th>Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for design in designs %}
                    <!-- Design Row (Level 1) -->
                    <tr class="design-row" data-design-id="{{ design.pk }}">
                        <td>
                            <i class="bi bi-caret-right-fill toggle-icon"></i>
                        </td>
                        <td><strong>L1</strong> <small class="text-muted">Design root</small></td>
                        <td>{{ design.design_mat_number|default:"—" }}</td>
                        <td>{{ design.get_bit_type_display }}</td>
                        <td>{{ design.size_inch|bit_size_display }}</td>
                        <td>{{ design.current_smi_name|default:"—" }}</td>
                        <td>{{ design.hdbs_name|default:"—" }}</td>
                        <td>{{ design.iadc_code|default:"—" }}</td>
                        <td>{{ design.get_body_material_display|default:"—" }}</td>
                        <td>{{ design.blade_count|default:"—" }}</td>
                        <td>{{ design.cutter_size_category|default:"—" }}</td>
                        <td>{{ design.gauge_length_inch|length_display }}</td>
                        <td>{{ design.connection_size|default:"—" }}</td>
                        <td>{{ design.get_connection_end_type_display|default:"—" }}</td>
                        <td>{{ design.get_drift_type_display|default:"—" }}</td>
                        <td>{{ design.nozzle_count|default:"—" }}</td>
                        <td>{{ design.port_count|default:"—" }}</td>
                        <td>{{ design.nozzle_size|default:"—" }}</td>
                        <td>{{ design.get_connection_type_display|default:"—" }}</td>
                        <td>{{ design.breaker_slot_width_inch|length_display }}</td>
                        <td>{{ design.breaker_slot_height_inch|length_display }}</td>
                        <td>{{ design.shank_diameter_inch|length_display }}</td>
                        <td>{{ design.gauge_relief_thou|default:"—" }}</td>
                        <td>
                            {% if design.active %}
                                <span class="badge bg-success">Yes</span>
                            {% else %}
                                <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </td>
                        <td onclick="event.stopPropagation();">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{% url 'production:bitdesign-detail' design.pk %}">
                                        <i class="bi bi-eye"></i> Open Design
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'production:bitdesign-edit' design.pk %}">
                                        <i class="bi bi-pencil"></i> Edit Design
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'production:bitdesign-mat-levels' design.pk %}">
                                        <i class="bi bi-layers"></i> MAT Levels
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-success" href="{% url 'production:design-create-level2' design.pk %}">
                                        <i class="bi bi-arrow-up-circle"></i> Create Level 2
                                    </a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>

                    <!-- Level Rows (2-6) -->
                    {% for rev in design.hub_revisions %}
                    <tr class="level-row level-row-{{ design.pk }}">
                        <td></td>
                        <td>
                            <strong>L{{ rev.level }}</strong>
                            {% if rev.level == 2 %}
                                <small class="text-muted d-block">Tooling</small>
                            {% elif rev.level == 3 %}
                                <small class="text-muted d-block">Head + Upper Kit</small>
                            {% elif rev.level == 4 %}
                                <small class="text-muted d-block">Welded, No Cutters</small>
                            {% elif rev.level == 5 %}
                                <small class="text-muted d-block">With Cutters</small>
                            {% elif rev.level == 6 %}
                                <small class="text-muted d-block">Ready to Run</small>
                            {% endif %}
                        </td>
                        <td>
                            {{ rev.mat_number }}
                            {% if rev.child_count >= 2 %}
                                <a href="{% url 'production:bitdesign-mat-levels' design.pk %}?prev_mat={{ rev.mat_number }}"
                                   class="text-decoration-none text-warning"
                                   title="View {{ rev.child_count }} child MATs">
                                    <i class="bi bi-diagram-3"></i> {{ rev.child_count }}
                                </a>
                            {% elif rev.child_count == 1 %}
                                <a href="{% url 'production:bitdesign-mat-levels' design.pk %}?prev_mat={{ rev.mat_number }}"
                                   class="text-decoration-none text-muted"
                                   title="View 1 child MAT">
                                    <i class="bi bi-arrow-down-circle"></i> 1
                                </a>
                            {% endif %}
                            {% if rev.variant_label %}
                                <br><small class="badge bg-info">{{ rev.variant_label }}</small>
                            {% endif %}
                        </td>
                        <td colspan="9" class="text-muted small">
                            {% if rev.previous_level %}
                                <strong>Prev:</strong>
                                <a href="{% url 'production:bitdesign-mat-levels' design.pk %}?search={{ rev.previous_level.mat_number }}"
                                   class="text-decoration-none"
                                   title="View parent MAT {{ rev.previous_level.mat_number }}">
                                    <i class="bi bi-arrow-up-circle"></i> {{ rev.previous_level.mat_number }} (L{{ rev.previous_level.level }})
                                </a>
                            {% endif %}
                            {% if rev.upper_welded is not None %}
                                | <strong>Upper:</strong> {% if rev.upper_welded %}Welded{% else %}Loose{% endif %}
                            {% endif %}
                            {% if rev.variant_notes %}
                                | <strong>Variant:</strong> {{ rev.variant_notes|truncatewords:10 }}
                            {% endif %}
                            {% if rev.remarks %}
                                | {{ rev.remarks|truncatewords:10 }}
                            {% endif %}
                        </td>
                        <td colspan="10"></td>
                        <td>{{ rev.effective_from|date:"Y-m-d" }}</td>
                        <td>
                            {% if rev.active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{% url 'production:bitdesign-mat-levels' design.pk %}">
                                        <i class="bi bi-eye"></i> View Level Details
                                    </a></li>
                                    <li><a class="dropdown-item" href="#">
                                        <i class="bi bi-list-ul"></i> View BOM
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    {% if rev.level < 6 %}
                                    <li><a class="dropdown-item text-success" href="{% url 'production:mat-create-next-level' rev.pk %}">
                                        <i class="bi bi-arrow-up-circle"></i> Create Level {{ rev.level|add:1 }}
                                    </a></li>
                                    {% endif %}
                                    <li><a class="dropdown-item" href="{% url 'production:mat-clone-branch' rev.pk %}">
                                        <i class="bi bi-diagram-3"></i> Clone as Branch
                                    </a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        {% else %}
        <p class="text-muted p-4">No designs found matching your filters.</p>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'production/js/bitdesign-hub-table.js' %}"></script>
{% endblock %}
