{% extends 'production/base.html' %}
{% load bit_format %}
{% block title %}Bit Design Hub{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.7.0/css/colReorder.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css">
<style>
    .design-row { background-color: #cfe2ff !important; cursor: pointer; }
    .design-row:hover { background-color: #b6d4fe !important; }
    .level-row { background-color: #f8f9fa; }
    .toggle-icon { transition: transform 0.2s; }
    .toggle-icon.expanded { transform: rotate(90deg); }
    table.dataTable thead th { padding: 12px 8px; }
    table.dataTable tbody td { padding: 8px; vertical-align: middle; }
    .dataTables_wrapper .dataTables_filter input { border-radius: 4px; }

    /* Professional toolbar styling */
    .dt-buttons { margin-bottom: 0.75rem; }
    .dt-button { border-radius: 4px !important; margin-right: 4px; }

    /* Fixed columns styling */
    table.dataTable.fixedColumns-left { border-right: 2px solid #dee2e6; }

    /* Compact mode */
    table.table-compact tbody td { padding: 4px 6px; font-size: 0.875rem; }
    table.table-compact thead th { padding: 8px 6px; font-size: 0.875rem; }
</style>
{% endblock %}

{% block content %}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'production:dashboard' %}"><i class="bi bi-house"></i> Production</a></li>
        <li class="breadcrumb-item active" aria-current="page">Bit Design Hub</li>
    </ol>
</nav>

<!-- Header with Search -->
<div class="row mb-3">
    <div class="col-md-6">
        <h1><i class="bi bi-grid-3x3-gap"></i> Bit Design Hub</h1>
        <p class="text-muted mb-0">Central junction for all bit designs (Levels 1-6) • {{ designs|length }} designs</p>
    </div>
    <div class="col-md-6 text-end">
        <a href="{% url 'production:bitdesign-create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> New Design
        </a>
    </div>
</div>

<!-- Hub Table -->
<div class="card">
    <div class="card-body p-0">
        {% if designs %}
        <div class="table-responsive">
            <table class="table table-sm table-hover" id="bitdesign-hub-table">
                <thead class="table-light">
                    <tr>
                        <th style="width:30px;"></th>
                        <th>Level</th>
                        <th>MAT</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>SMI Name</th>
                        <th>HDBS</th>
                        <th>IADC</th>
                        <th>Body</th>
                        <th>Blades</th>
                        <th>Cutter Cat</th>
                        <th>Gauge L.</th>
                        <th>Conn. Size</th>
                        <th>Conn. End</th>
                        <th>Drift</th>
                        <th>Nozzles</th>
                        <th>Ports</th>
                        <th>Nozzle Size</th>
                        <th>Conn. Type</th>
                        <th>Breaker W.</th>
                        <th>Breaker H.</th>
                        <th>Shank Dia.</th>
                        <th>Gauge Relief</th>
                        <th>Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for design in designs %}
                    <!-- Design Row (Level 1) -->
                    <tr class="design-row table-primary" data-design-id="{{ design.pk }}" style="cursor: pointer;">
                        <td>
                            <i class="bi bi-caret-right-fill toggle-icon"></i>
                        </td>
                        <td><strong>L1</strong> <small class="text-muted">Design root</small></td>
                        <td>{{ design.design_mat_number|default:"—" }}</td>
                        <td>{{ design.get_bit_type_display }}</td>
                        <td>{{ design.size_inch|bit_size_display }}</td>
                        <td>{{ design.current_smi_name|default:"—" }}</td>
                        <td>{{ design.hdbs_name|default:"—" }}</td>
                        <td>{{ design.iadc_code|default:"—" }}</td>
                        <td>{{ design.get_body_material_display|default:"—" }}</td>
                        <td>{{ design.blade_count|default:"—" }}</td>
                        <td>{{ design.cutter_size_category|default:"—" }}</td>
                        <td>{{ design.gauge_length_inch|length_display }}</td>
                        <td>{{ design.connection_size|default:"—" }}</td>
                        <td>{{ design.get_connection_end_type_display|default:"—" }}</td>
                        <td>{{ design.get_drift_type_display|default:"—" }}</td>
                        <td>{{ design.nozzle_count|default:"—" }}</td>
                        <td>{{ design.port_count|default:"—" }}</td>
                        <td>{{ design.nozzle_size|default:"—" }}</td>
                        <td>{{ design.get_connection_type_display|default:"—" }}</td>
                        <td>{{ design.breaker_slot_width_inch|length_display }}</td>
                        <td>{{ design.breaker_slot_height_inch|length_display }}</td>
                        <td>{{ design.shank_diameter_inch|length_display }}</td>
                        <td>{{ design.gauge_relief_thou|default:"—" }}</td>
                        <td>
                            {% if design.active %}
                                <span class="badge bg-success">Yes</span>
                            {% else %}
                                <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </td>
                        <td onclick="event.stopPropagation();">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{% url 'production:bitdesign-detail' design.pk %}">
                                        <i class="bi bi-eye"></i> Open Design
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'production:bitdesign-edit' design.pk %}">
                                        <i class="bi bi-pencil"></i> Edit Design
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'production:bitdesign-mat-levels' design.pk %}">
                                        <i class="bi bi-layers"></i> MAT Levels
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-success" href="{% url 'production:design-create-level2' design.pk %}">
                                        <i class="bi bi-arrow-up-circle"></i> Create Level 2
                                    </a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>

                    <!-- Level Rows (2-6) -->
                    {% for rev in design.hub_revisions %}
                    <tr class="level-row level-row-{{ design.pk }}" style="display:none;">
                        <td></td>
                        <td>
                            <strong>L{{ rev.level }}</strong>
                            {% if rev.level == 2 %}
                                <small class="text-muted d-block">Tooling</small>
                            {% elif rev.level == 3 %}
                                <small class="text-muted d-block">Head + Upper Kit</small>
                            {% elif rev.level == 4 %}
                                <small class="text-muted d-block">Welded, No Cutters</small>
                            {% elif rev.level == 5 %}
                                <small class="text-muted d-block">With Cutters</small>
                            {% elif rev.level == 6 %}
                                <small class="text-muted d-block">Ready to Run</small>
                            {% endif %}
                        </td>
                        <td>
                            {{ rev.mat_number }}
                            {% if rev.child_count >= 2 %}
                                <a href="{% url 'production:bitdesign-mat-levels' design.pk %}?prev_mat={{ rev.mat_number }}"
                                   class="text-decoration-none text-warning"
                                   title="View {{ rev.child_count }} child MATs">
                                    <i class="bi bi-diagram-3"></i> {{ rev.child_count }}
                                </a>
                            {% elif rev.child_count == 1 %}
                                <a href="{% url 'production:bitdesign-mat-levels' design.pk %}?prev_mat={{ rev.mat_number }}"
                                   class="text-decoration-none text-muted"
                                   title="View 1 child MAT">
                                    <i class="bi bi-arrow-down-circle"></i> 1
                                </a>
                            {% endif %}
                            {% if rev.variant_label %}
                                <br><small class="badge bg-info">{{ rev.variant_label }}</small>
                            {% endif %}
                        </td>
                        <td colspan="9" class="text-muted small">
                            {% if rev.previous_level %}
                                <strong>Prev:</strong>
                                <a href="{% url 'production:bitdesign-mat-levels' design.pk %}?search={{ rev.previous_level.mat_number }}"
                                   class="text-decoration-none"
                                   title="View parent MAT {{ rev.previous_level.mat_number }}">
                                    <i class="bi bi-arrow-up-circle"></i> {{ rev.previous_level.mat_number }} (L{{ rev.previous_level.level }})
                                </a>
                            {% endif %}
                            {% if rev.upper_welded is not None %}
                                | <strong>Upper:</strong> {% if rev.upper_welded %}Welded{% else %}Loose{% endif %}
                            {% endif %}
                            {% if rev.variant_notes %}
                                | <strong>Variant:</strong> {{ rev.variant_notes|truncatewords:10 }}
                            {% endif %}
                            {% if rev.remarks %}
                                | {{ rev.remarks|truncatewords:10 }}
                            {% endif %}
                        </td>
                        <td colspan="10"></td>
                        <td>{{ rev.effective_from|date:"Y-m-d" }}</td>
                        <td>
                            {% if rev.active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{% url 'production:bitdesign-mat-levels' design.pk %}">
                                        <i class="bi bi-eye"></i> View Level Details
                                    </a></li>
                                    <li><a class="dropdown-item" href="#">
                                        <i class="bi bi-list-ul"></i> View BOM
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    {% if rev.level < 6 %}
                                    <li><a class="dropdown-item text-success" href="{% url 'production:mat-create-next-level' rev.pk %}">
                                        <i class="bi bi-arrow-up-circle"></i> Create Level {{ rev.level|add:1 }}
                                    </a></li>
                                    {% endif %}
                                    <li><a class="dropdown-item" href="{% url 'production:mat-clone-branch' rev.pk %}">
                                        <i class="bi bi-diagram-3"></i> Clone as Branch
                                    </a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No designs found matching your filters.</p>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- jQuery (required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>
<script src="https://cdn.datatables.net/colreorder/1.7.0/js/dataTables.colReorder.min.js"></script>
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable with Excel-like features
    var table = $('#bitdesign-hub-table').DataTable({
        // Paging
        paging: true,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],

        // Searching
        searching: true,
        search: {
            smart: true,
            regex: false
        },

        // Ordering
        ordering: true,
        order: [[3, 'asc'], [4, 'asc']], // Type then Size

        // Display
        info: true,
        autoWidth: false,
        responsive: false,

        // Professional features
        colReorder: true,  // Drag-drop column reordering
        fixedColumns: {
            leftColumns: 3  // Freeze toggle, level, and MAT columns
        },
        select: {
            style: 'multi',
            selector: 'td:not(:last-child)'  // Select rows (except actions column)
        },

        // Buttons toolbar
        buttons: [
            {
                extend: 'colvis',
                text: '<i class="bi bi-layout-three-columns"></i> Columns',
                titleAttr: 'Show/hide columns'
            },
            {
                extend: 'excel',
                text: '<i class="bi bi-file-earmark-excel"></i> Excel',
                titleAttr: 'Export to Excel',
                exportOptions: {
                    columns: ':visible:not(:first-child):not(:last-child)'  // Exclude toggle icon and actions
                }
            },
            {
                extend: 'pdf',
                text: '<i class="bi bi-file-earmark-pdf"></i> PDF',
                titleAttr: 'Export to PDF',
                orientation: 'landscape',
                pageSize: 'A3',
                exportOptions: {
                    columns: ':visible:not(:first-child):not(:last-child)'
                }
            },
            {
                extend: 'copy',
                text: '<i class="bi bi-clipboard"></i> Copy',
                titleAttr: 'Copy to clipboard',
                exportOptions: {
                    columns: ':visible:not(:first-child):not(:last-child)'
                }
            }
        ],

        // Layout with buttons
        dom: '<"row mb-3"<"col-sm-12 col-md-4"l><"col-sm-12 col-md-4 text-center"B><"col-sm-12 col-md-4"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',

        // Language
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search all columns...",
            lengthMenu: "Show _MENU_ rows",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "No entries available",
            infoFiltered: "(filtered from _TOTAL_ total entries)",
            zeroRecords: "No matching designs found",
            emptyTable: "No designs available",
            buttons: {
                colvis: 'Column Visibility',
                colvisRestore: 'Restore columns'
            }
        },

        // Column-specific settings
        columnDefs: [
            { orderable: false, targets: [0, -1] }, // Disable sorting on toggle icon and actions
            { className: 'text-center', targets: [0, 2, 8, 9, 10, 15, 16, 22, 23] }, // Center align specific columns
            { width: '30px', targets: 0 }, // Toggle icon
            { width: '80px', targets: 1 }, // Level
            { width: '60px', targets: 4 }, // Size
            { width: '120px', targets: -1 } // Actions
        ],

        // Initialize with all level rows hidden
        initComplete: function() {
            // Hide all level rows initially
            $('.level-row').hide();
        }
    });

    // Toggle design rows to show/hide levels
    $('#bitdesign-hub-table tbody').on('click', 'tr.design-row', function(e) {
        // Don't toggle if clicking on dropdown or links
        if ($(e.target).closest('.dropdown, a, button').length) return;

        const designId = $(this).data('design-id');
        const levelRows = $('.level-row-' + designId);
        const icon = $(this).find('.toggle-icon');

        if (levelRows.first().is(':visible')) {
            // Collapse
            levelRows.hide();
            icon.removeClass('bi-caret-down-fill expanded').addClass('bi-caret-right-fill');
        } else {
            // Expand
            levelRows.show();
            icon.removeClass('bi-caret-right-fill').addClass('bi-caret-down-fill expanded');
        }
    });
});
</script>
{% endblock %}
