{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}{{ title }} - Floor Management System{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-section h5 {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .group-checkbox {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s;
    }
    .group-checkbox:hover {
        background-color: #f8f9fa;
    }
    .required-field::after {
        content: " *";
        color: red;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-person-plus-fill"></i> {{ title }}
        </h1>
        <a href="{% url 'core:user_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Users
        </a>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    <form method="post" novalidate>
        {% csrf_token %}

        <!-- Basic Information -->
        <div class="form-section">
            <h5><i class="bi bi-person-badge"></i> Basic Information</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.username.id_for_label }}" class="form-label required-field">Username</label>
                    {% render_field form.username class="form-control" %}
                    {% if form.username.errors %}
                        <div class="text-danger">{{ form.username.errors }}</div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.username.help_text }}</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.email.id_for_label }}" class="form-label">Email Address</label>
                    {% render_field form.email class="form-control" %}
                    {% if form.email.errors %}
                        <div class="text-danger">{{ form.email.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name</label>
                    {% render_field form.first_name class="form-control" %}
                    {% if form.first_name.errors %}
                        <div class="text-danger">{{ form.first_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name</label>
                    {% render_field form.last_name class="form-control" %}
                    {% if form.last_name.errors %}
                        <div class="text-danger">{{ form.last_name.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Password (for new users) -->
        {% if form.password1 %}
        <div class="form-section">
            <h5><i class="bi bi-key-fill"></i> Password</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.password1.id_for_label }}" class="form-label required-field">Password</label>
                    {% render_field form.password1 class="form-control" %}
                    {% if form.password1.errors %}
                        <div class="text-danger">{{ form.password1.errors }}</div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.password1.help_text }}</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.password2.id_for_label }}" class="form-label required-field">Confirm Password</label>
                    {% render_field form.password2 class="form-control" %}
                    {% if form.password2.errors %}
                        <div class="text-danger">{{ form.password2.errors }}</div>
                    {% endif %}
                    <small class="form-text text-muted">{{ form.password2.help_text }}</small>
                </div>
            </div>
            <div class="alert alert-info">
                <strong>Password Requirements:</strong>
                <ul class="mb-0">
                    <li>At least 8 characters long</li>
                    <li>Cannot be too similar to other personal information</li>
                    <li>Cannot be a commonly used password</li>
                    <li>Cannot be entirely numeric</li>
                </ul>
            </div>
        </div>
        {% endif %}

        <!-- Permissions & Status -->
        <div class="form-section">
            <h5><i class="bi bi-shield-check"></i> Permissions & Status</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="form-check">
                        {% render_field form.is_active class="form-check-input" %}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            Active
                        </label>
                    </div>
                    <small class="form-text text-muted">{{ form.is_active.help_text }}</small>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="form-check">
                        {% render_field form.is_staff class="form-check-input" %}
                        <label class="form-check-label" for="{{ form.is_staff.id_for_label }}">
                            Staff Status
                        </label>
                    </div>
                    <small class="form-text text-muted">{{ form.is_staff.help_text }}</small>
                </div>
            </div>
        </div>

        <!-- Group Membership -->
        <div class="form-section">
            <h5><i class="bi bi-people-fill"></i> Group Membership</h5>
            {% if form.groups.field.queryset %}
                <div class="row">
                    {% for group in form.groups.field.queryset %}
                    <div class="col-md-6 col-lg-4 mb-2">
                        <div class="group-checkbox">
                            <div class="form-check">
                                <input type="checkbox"
                                       class="form-check-input"
                                       name="groups"
                                       value="{{ group.id }}"
                                       id="group_{{ group.id }}"
                                       {% if group in form.groups.value or group.id in form.groups.value %}checked{% endif %}>
                                <label class="form-check-label" for="group_{{ group.id }}">
                                    <strong>{{ group.name }}</strong>
                                    <br><small class="text-muted">{{ group.permissions.count }} permission(s)</small>
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if form.groups.errors %}
                    <div class="text-danger mt-2">{{ form.groups.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">{{ form.groups.help_text }}</small>
            {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> No groups available. <a href="{% url 'core:group_create' %}">Create a group</a> first.
                </div>
            {% endif %}
        </div>

        <!-- Form Actions -->
        <div class="form-section">
            <div class="d-flex justify-content-between">
                <a href="{% url 'core:user_list' %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> {{ action }} User
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation feedback
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');

        form.addEventListener('submit', function(e) {
            // Add was-validated class for Bootstrap validation
            form.classList.add('was-validated');
        });

        // Password strength indicator (optional enhancement)
        const password1 = document.querySelector('input[name="password1"]');
        if (password1) {
            password1.addEventListener('input', function() {
                const value = this.value;
                const strength = calculatePasswordStrength(value);
                // You can add visual feedback here
            });
        }
    });

    function calculatePasswordStrength(password) {
        let strength = 0;
        if (password.length >= 8) strength += 1;
        if (password.length >= 12) strength += 1;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;
        if (/\d/.test(password)) strength += 1;
        if (/[^a-zA-Z0-9]/.test(password)) strength += 1;
        return strength;
    }
</script>
{% endblock %}
